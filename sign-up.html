<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign Up - BookHaven</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.css"
    integrity="sha512-k+xZuzf4IaGQK9sSDjaNyrfwgxBfoF++7u6Q0ZVUs2rDczx9doNZkYXyyQbnJQcMR4o+IjvAcIj69hHxiOZEig=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link rel="stylesheet" href="src/css/auth.css" />
  <link rel="stylesheet" href="src/css/variables.css" />
  <link rel="stylesheet" href="src/css/global.css" />
</head>

<body>
  <div class="auth-container">
    <div class="container">
      <div class="row justify-content-center align-items-center min-vh-100">
        <div class="col-md-5">
          <div class="auth-card">
            <!-- Logo and Title -->
            <div class="text-center mb-4">

              <h4 class="auth-title">Sign up to BookHaven</h4>
            </div>

            <!-- Social Login -->
            <div class="social-buttons">
              <button class="social-btn">
                <img src="src/images/facebook.svg" alt="Facebook" />
              </button>
              <button class="social-btn">
                <img src="src/images/google.svg" alt="Google" />
              </button>
              <button class="social-btn">
                <img src="src/images/apple.svg" alt="Apple" />
              </button>
            </div>

            <div class="divider">
              <span>or do via email</span>
            </div>

            <!-- Signup Form -->
            <form class="auth-form" id="signupForm" novalidate>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="firstName" placeholder="First Name" required />
                    <label for="firstName">First Name</label>
                    <div class="invalid-feedback">Please enter your first name</div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="lastName" placeholder="Last Name" required />
                    <label for="lastName">Last Name</label>
                    <div class="invalid-feedback">Please enter your last name</div>
                  </div>
                </div>
              </div>

              <div class="form-floating mb-3">
                <input type="date" class="form-control" id="birthday" placeholder="Birthday" required />
                <label for="birthday">Birthday</label>
                <div class="invalid-feedback">Please select your birthday</div>
              </div>

              <div class="form-floating mb-3">
                <select class="form-select" id="gender" aria-label="Gender" required>
                  <option selected disabled value="">Select gender</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                </select>
                <label for="gender">Gender</label>
                <div class="invalid-feedback">Please select your gender</div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <div class="form-floating mb-3">
                    <input type="email" class="form-control" id="email" placeholder="name@example.com" required />
                    <label for="email">Email address</label>
                    <div class="invalid-feedback">Please enter a valid email address</div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <div class="form-floating mb-3">
                    <input type="tel" class="form-control" id="phone" placeholder="Phone Number" required />
                    <label for="phone">Phone Number</label>
                    <div class="invalid-feedback">Please enter a valid phone number</div>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <div class="password-field form-floating mb-3">
                    <input type="password" class="form-control" id="password" placeholder="Password" required />
                    <label for="password">Password</label>
                    <button type="button" class="password-toggle">
                      <i class="far fa-eye"></i>
                    </button>
                    <div class="invalid-feedback">Password must be at least 8 characters and contain at least 1
                      uppercase letter, lowercase letter, number, and special
                      character
                    </div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <div class="password-field form-floating mb-3">
                    <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm Password"
                      required />
                    <label for="confirmPassword">Confirm Password</label>
                    <button type="button" class="password-toggle">
                      <i class="far fa-eye"></i>
                    </button>
                    <div class="invalid-feedback">Passwords do not match</div>
                  </div>
                </div>
              </div>

              <div class="form-floating mb-3">
                <select class="form-select" id="role" aria-label="Role" required>
                  <option selected disabled value="">Select role</option>
                  <option value="client">Customer</option>
                  <option value="seller">Seller</option>
                </select>
                <label for="role">Role</label>
                <div class="invalid-feedback">Please select a role</div>
              </div>

              <button type="submit" class="btn btn-auth w-100">
                Sign up
              </button>
            </form>

            <div class="text-center mt-4">
              <p class="auth-link">
                Have an account? <a href="sign-in.html">Sign in</a>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"
    integrity="sha512-0Yc4Jv5wX4+mjDuLxmHFGqgDtMFAEBLpPq/0nPVmAOwHPMkYXiS1YVYWTcrVQztftk/32089DDTyrCJO8hBCZw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const currentUser = localStorage.getItem("currentUser") || null;
      if (currentUser) window.location.replace("home.html");

      // Retrieve users from localStorage or initialize an empty array
      const usersStorage = localStorage.getItem("users");
      const users = usersStorage ? JSON.parse(usersStorage) : [{
        firstName: "Admin",
        lastName: "Admin",
        birthday: "1990-01-01",
        gender: "male",
        email: "admin@gmail.com",
        phone: "01000000000",
        password: "Admin@123",
        role: "admin",
        cart: [],
      }];

      if (!usersStorage) {
        localStorage.setItem("users", JSON.stringify(users));
      }

      // Check if the user email already exists
      const isEmailExists = (email) => users.find((user) => user.email === email);

      // Check if the phone number already exists
      const isPhoneExists = (phone) => users.find((user) => user.phone === phone);

      // Password visibility toggle
      document.querySelectorAll('.password-toggle').forEach(button => {
        button.addEventListener('click', function() {
          const input = this.closest('.password-field').querySelector('input');
          const icon = this.querySelector('i');

          if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
          } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
          }
        });
      });

      // Individual field validation functions
      function validateFirstName() {
        const firstNameInput = document.getElementById('firstName');
        const nameRegex = /^[A-Za-z]+$/;
        const isValid = nameRegex.test(firstNameInput.value.trim());
        
        firstNameInput.classList.toggle('is-invalid', !isValid);
        return isValid;
      }

      function validateLastName() {
        const lastNameInput = document.getElementById('lastName');
        const nameRegex = /^[A-Za-z]+$/;
        const isValid = nameRegex.test(lastNameInput.value.trim());
        
        lastNameInput.classList.toggle('is-invalid', !isValid);
        return isValid;
      }

      function validateBirthday() {
        const birthdayInput = document.getElementById('birthday');
        const selectedDate = new Date(birthdayInput.value);
        const today = new Date();
        const minAge = 13;
        const maxAge = 100;
        
        const age = today.getFullYear() - selectedDate.getFullYear();
        const isValid = age >= minAge && age <= maxAge;
        
        birthdayInput.classList.toggle('is-invalid', !isValid);
        return isValid;
      }

      function validateGender() {
        const genderSelect = document.getElementById('gender');
        const isValid = genderSelect.value !== '';
        
        genderSelect.classList.toggle('is-invalid', !isValid);
        return isValid;
      }

      function validateEmail() {
        const emailInput = document.getElementById('email');
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const email = emailInput.value.trim();
        
        const isValidFormat = emailRegex.test(email);
        const exists = isEmailExists(email);
        const isValid = isValidFormat && !exists;
        
        emailInput.classList.toggle('is-invalid', !isValid);
        
        if (!isValidFormat) {
          emailInput.nextElementSibling.nextElementSibling.textContent = 'Please enter a valid email address';
        } else if (exists) {
          emailInput.nextElementSibling.nextElementSibling.textContent = 'This email is already registered';
        }
        
        return isValid;
      }

      function validatePhone() {
        const phoneInput = document.getElementById('phone');
        const phoneRegex = /^[0-9]{11}$/;
        const phone = phoneInput.value.trim();
        
        const isValidFormat = phoneRegex.test(phone);
        const exists = isPhoneExists(phone);
        const isValid = isValidFormat && !exists;
        
        phoneInput.classList.toggle('is-invalid', !isValid);
        
        if (!isValidFormat) {
          phoneInput.nextElementSibling.nextElementSibling.textContent = 'Please enter a valid 11-digit phone number';
        } else if (exists) {
          phoneInput.nextElementSibling.nextElementSibling.textContent = 'This phone number is already registered';
        }
        
        return isValid;
      }

     function validatePassword() {
        const passwordInput = $('#password');
        const password = passwordInput.val();

        if (!password) {
          passwordInput.addClass('is-invalid');
          passwordInput.siblings('.invalid-feedback').text('Password is required');
          return false;
        }

        const hasMinLength = password.length >= 8;
        const hasUpperCase = /[A-Z]/.test(password);
        const hasLowerCase = /[a-z]/.test(password);
        const hasNumbers = /\d/.test(password);
        const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);

        if (!hasMinLength || !hasUpperCase || !hasLowerCase || !hasNumbers || !hasSpecialChar) {
          passwordInput.addClass('is-invalid');
          passwordInput.siblings('.invalid-feedback').text('Password must be at least 8 characters and contain at least 1 uppercase letter, lowercase letter, number, and special character');
          return false;
        }
        passwordInput.removeClass('is-invalid');
        return true;
      }

      function validateConfirmPassword() {
        const confirmInput = $('#confirmPassword');
        const password = $('#password').val();
        const confirm = confirmInput.val();

        if (!confirm) {
          confirmInput.addClass('is-invalid');
          confirmInput.siblings('.invalid-feedback').text('Confirm password is required');
          return false;
        } else if (password !== confirm) {
          confirmInput.addClass('is-invalid');
          return false;
        }
        confirmInput.removeClass('is-invalid');
        return true;
      }

      function validateRole() {
        const roleSelect = document.getElementById('role');
        const isValid = roleSelect.value !== '';
        
        roleSelect.classList.toggle('is-invalid', !isValid);
        return isValid;
      }

      // Form submission
      document.getElementById('signupForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const isValid = validateFirstName() &&
          validateLastName() &&
          validateBirthday() &&
          validateGender() &&
          validateEmail() &&
          validatePhone() &&
          validatePassword() &&
          validateConfirmPassword() &&
          validateRole();

        if (isValid) {
          const newUser = {
            firstName: document.getElementById('firstName').value.trim(),
            lastName: document.getElementById('lastName').value.trim(),
            birthday: document.getElementById('birthday').value,
            gender: document.getElementById('gender').value,
            email: document.getElementById('email').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            password: document.getElementById('password').value,
            role: document.getElementById('role').value,
            cart: [],
            history: [],
            Bill: [],
            customerServiceMessages: [],
          };

          users.push(newUser);
          localStorage.setItem('users', JSON.stringify(users));

          Toastify({
            text: "Sign up successful! Please sign in.",
            duration: 3000,
            gravity: "top",
            position: "right",
            style: {
              background: "linear-gradient(to right, #00b09b, #96c93d)",
            },
            callback: function() {
              window.location.href = "sign-in.html";
            }
          }).showToast();
        }
      });

      // Validate individual fields on input
      document.getElementById('firstName').addEventListener('input', validateFirstName);
      document.getElementById('lastName').addEventListener('input', validateLastName);
      document.getElementById('birthday').addEventListener('input', validateBirthday);
      document.getElementById('gender').addEventListener('change', validateGender);
      document.getElementById('email').addEventListener('input', validateEmail);
      document.getElementById('phone').addEventListener('input', validatePhone);
      document.getElementById('password').addEventListener('input', validatePassword);
      document.getElementById('confirmPassword').addEventListener('input', validateConfirmPassword);
      document.getElementById('role').addEventListener('change', validateRole);
    });
  </script>
</body>

</html>